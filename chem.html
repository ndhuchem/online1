<main id="main-content" class="container">
    <div class="analyzer-wrapper" style="margin: 40px auto; max-width: 800px; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
        <h2 style="color: #1a73e8; border-bottom: 2px solid #e8f0fe; padding-bottom: 10px;">ğŸ§ª åŒ–å­¸åˆ†å­çµæ§‹åˆ†æç³»çµ±(å¯èƒ½å­˜åœ¨å¤§é‡éŒ¯èª¤ è¬¹æ…ä½¿ç”¨)</h2>
        
        <label style="font-weight: bold; display: block; margin-top: 15px;">1. è¼¸å…¥åŒ–å­¸å¼ (æ ¼å¼ï¼š(åŸå­ç¬¦è™Ÿ)(æ•¸é‡))</label>
        <input type="text" id="formula" placeholder="ä¾‹å¦‚ï¼š(C)(1)(O)(2)" style="width: 100%; padding: 12px; margin: 8px 0; border: 1.5px solid #ddd; border-radius: 6px;">
        
        <button class="btn-generate" py-click="generate_ids" style="background: #34a853; color: white; width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">1. ç”ŸæˆåŸå­ç·¨è™Ÿ</button>
        
        <div id="id_hint" style="background: #fff3e0; padding: 10px; border-left: 5px solid #ff9800; margin: 10px 0; border-radius: 4px; font-family: monospace;">ç­‰å¾…è¼¸å…¥åŒ–å­¸å¼...</div>
        
        <label style="font-weight: bold; display: block; margin-top: 15px;">2. è¼¸å…¥ç¸½é›»è·</label>
        <input type="number" id="charge" value="0" style="width: 100%; padding: 12px; margin: 8px 0; border: 1.5px solid #ddd; border-radius: 6px;">
        
        <label style="font-weight: bold; display: block; margin-top: 15px;">3. è¼¸å…¥é€£æ¥é—œä¿‚</label>
        <textarea id="bonds" rows="4" placeholder="ä¾‹å¦‚ï¼š0 1" style="width: 100%; padding: 12px; margin: 8px 0; border: 1.5px solid #ddd; border-radius: 6px;"></textarea>
        
        <div class="button-group" style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn-analyze" py-click="run_analysis" style="flex: 1; padding: 12px; background: #1a73e8; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">2. é–‹å§‹åˆ†æçµæœ</button>
            <button class="btn-reset" py-click="reset_all" style="flex: 1; padding: 12px; background: #ea4335; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">é‡è¨­æ¸…é™¤</button>
        </div>
        
        <div id="output" style="background: #202124; color: #e8eaed; padding: 20px; border-radius: 8px; white-space: pre-wrap; margin-top: 20px; font-family: monospace;">åˆ†æçµæœå°‡é¡¯ç¤ºæ–¼æ­¤...</div>

        <div class="return-home" style="text-align: center; margin-top: 20px;">
            <a href="/index.html" class="btn">è¿”å›é¦–é </a>
        </div>
    </div>
    <script type="py">
        from pyscript import document
        import re

        ELEMENT_DICT = {
            "H":  {"en": 2.20, "ve": 1}, 
            "He": {"en": 0.00, "ve": 2},
            "Li": {"en": 0.98, "ve": 1}, 
            "Be": {"en": 1.57, "ve": 2},
            "B":  {"en": 2.04, "ve": 3}, 
            "C":  {"en": 2.55, "ve": 4},
            "N":  {"en": 3.04, "ve": 5}, 
            "O":  {"en": 3.44, "ve": 6},
            "F":  {"en": 3.98, "ve": 7}, 
            "Ne": {"en": 0.00, "ve": 8},
            "Na": {"en": 0.93, "ve": 1}, 
            "Mg": {"en": 1.31, "ve": 2},
            "Al": {"en": 1.61, "ve": 3}, 
            "Si": {"en": 1.90, "ve": 4},
            "P":  {"en": 2.19, "ve": 5}, 
            "S":  {"en": 2.58, "ve": 6},
            "Cl": {"en": 3.16, "ve": 7}, 
            "Ar": {"en": 0.00, "ve": 8},
            "K":  {"en": 0.82, "ve": 1}
        }
        def parse_formula():
            formula_str = document.querySelector("#formula").value
            nodes = []
            matches = re.findall(r"\(([A-Za-z]+)\)\((\d+)\)", formula_str)
            for sym, count in matches:
                if sym in ELEMENT_DICT:
                    for _ in range(int(count)):
                        nodes.append({"sym": sym, "rem_e": ELEMENT_DICT[sym]["ve"]})
            return nodes
        def generate_ids(event):
            nodes = parse_formula()
            hint_div = document.querySelector("#id_hint")
            if not nodes:
                hint_div.innerText = "âš  æ ¼å¼ä¸æ­£ç¢ºï¼è«‹ä½¿ç”¨ (C)(1)(O)(2) æ ¼å¼ã€‚"
                return
            hints = [f"[{i}]:{n['sym']}" for i, n in enumerate(nodes)]
            hint_div.innerText = "åŸå­ç·¨è™Ÿï¼š " + "  ".join(hints)
            document.querySelector("#bonds").placeholder = f"è‹¥ç·¨è™Ÿ 0 èˆ‡ 1 æœ‰é€£æ¥ï¼Œè«‹åœ¨æ­¤è¼¸å…¥ï¼š0 1"
        def run_analysis(event):
            output_div = document.querySelector("#output")
            nodes = parse_formula()
            if not nodes:
                output_div.innerText = "éŒ¯èª¤ï¼šè«‹å…ˆè¼¸å…¥åŒ–å­¸å¼ä¸¦é»æ“Šç”Ÿæˆç·¨è™Ÿã€‚"
                return
            charge = int(document.querySelector("#charge").value or 0)
            bonds_str = document.querySelector("#bonds").value
            total_atoms = len(nodes)
            adj = [[0] * total_atoms for _ in range(total_atoms)]
            for line in bonds_str.strip().split('\n'):
                try:
                    parts = line.split()
                    if len(parts) == 2:
                        a, b = map(int, parts)
                        if a < total_atoms and b < total_atoms:
                            adj[a][b] = adj[b][a] = 1
                except: continue
            nodes[0]["rem_e"] -= charge 
            for i in range(total_atoms):
                for j in range(i + 1, total_atoms):
                    if adj[i][j] >= 1:
                        nodes[i]["rem_e"] -= 1
                        nodes[j]["rem_e"] -= 1
            for i in range(total_atoms):
                while nodes[i]["rem_e"] > 0:
                    added = False
                    for j in range(total_atoms):
                        if adj[i][j] >= 1 and nodes[j]["rem_e"] > 0:
                            adj[i][j] += 1
                            adj[j][i] += 1
                            nodes[i]["rem_e"] -= 1
                            nodes[j]["rem_e"] -= 1
                            added = True
                            break
                    if not added: break
            res = f"{'ç·¨è™Ÿ':<6} {'åŸå­':<6} {'ç¸½éµæ•¸':<8} {'LP':<6} {'å½¢ç‹€':<12}\n"
            res += "="*45 + "\n"
            max_en, min_en, has_HB = -1.0, 10.0, False
            for i in range(total_atoms):
                sym = nodes[i]["sym"]
                e_data = ELEMENT_DICT[sym]
                max_en = max(max_en, e_data["en"])
                if e_data["en"] > 0: min_en = min(min_en, e_data["en"])
                b_sum, nbr = 0, 0
                for j in range(total_atoms):
                    if adj[i][j] > 0:
                        b_sum += adj[i][j]
                        nbr += 1
                        if sym == "H" and nodes[j]["sym"] in ["F", "O", "N"]: has_HB = True
                lp = max(0, nodes[i]["rem_e"] // 2)
                sn = nbr + lp
                sh = "æœ«ç«¯"
                if sn == 4: sh = "å››é¢é«”" if lp == 0 else ("ä¸‰è§’éŒ" if lp == 1 else "è§’å½¢")
                elif sn == 3: sh = "å¹³é¢ä¸‰è§’" if lp == 0 else "è§’å½¢"
                elif sn == 2: sh = "ç·šæ€§"
                res += f"{i:<8} {sym:<8} {b_sum:<10} {lp:<8} {sh}\n"
            output_div.innerText = res + f"\n[åˆ†æå ±å‘Š]\næ¥µæ€§å¼·åº¦: {max_en - min_en:.2f}\næ°«éµå¯èƒ½: {'æœ‰' if has_HB else 'ç„¡'}"
        def reset_all(event):
            document.querySelector("#formula").value = ""
            document.querySelector("#charge").value = "0"
            document.querySelector("#bonds").value = ""
            document.querySelector("#id_hint").innerText = "ç­‰å¾…è¼¸å…¥åŒ–å­¸å¼..."
            document.querySelector("#output").innerText = "åˆ†æçµæœå°‡é¡¯ç¤ºæ–¼æ­¤..."
    </script>
</main>