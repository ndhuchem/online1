<main id="main-content" class="container">
    <div class="analyzer-wrapper" style="margin: 40px auto; max-width: 800px; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
        <h2 style="color: #1a73e8; border-bottom: 2px solid #e8f0fe; padding-bottom: 10px;">ğŸ§ª åŒ–å­¸åˆ†å­çµæ§‹åˆ†æç³»çµ±(å¯èƒ½å­˜åœ¨å¤§é‡éŒ¯èª¤ è¬¹æ…ä½¿ç”¨)</h2>
        
        <label style="font-weight: bold; display: block; margin-top: 15px;">1. è¼¸å…¥åŒ–å­¸å¼ (æ ¼å¼ï¼š(åŸå­ç¬¦è™Ÿ)(æ•¸é‡))</label>
        <input type="text" id="formula" placeholder="ä¾‹å¦‚ï¼š(C)(1)(O)(2)" style="width: 100%; padding: 12px; margin: 8px 0; border: 1.5px solid #ddd; border-radius: 6px;">
        
        <button class="btn-generate" py-click="generate_ids" style="background: #34a853; color: white; width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">1. ç”ŸæˆåŸå­ç·¨è™Ÿ</button>
        
        <div id="id_hint" style="background: #fff3e0; padding: 10px; border-left: 5px solid #ff9800; margin: 10px 0; border-radius: 4px; font-family: monospace;">ç­‰å¾…è¼¸å…¥åŒ–å­¸å¼...</div>
        
        <label style="font-weight: bold; display: block; margin-top: 15px;">2. è¼¸å…¥ç¸½é›»è·</label>
        <input type="number" id="charge" value="0" style="width: 100%; padding: 12px; margin: 8px 0; border: 1.5px solid #ddd; border-radius: 6px;">
        
        <label style="font-weight: bold; display: block; margin-top: 15px;">3. è¼¸å…¥é€£æ¥é—œä¿‚</label>
        <textarea id="bonds" rows="4" placeholder="ä¾‹å¦‚ï¼š0 1" style="width: 100%; padding: 12px; margin: 8px 0; border: 1.5px solid #ddd; border-radius: 6px;"></textarea>
        
        <div class="button-group" style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn-analyze" py-click="run_analysis" style="flex: 1; padding: 12px; background: #1a73e8; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">2. é–‹å§‹åˆ†æçµæœ</button>
            <button class="btn-reset" py-click="reset_all" style="flex: 1; padding: 12px; background: #ea4335; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">é‡è¨­æ¸…é™¤</button>
        </div>
        
        <div id="output" style="background: #202124; color: #e8eaed; padding: 20px; border-radius: 8px; white-space: pre-wrap; margin-top: 20px; font-family: monospace;">åˆ†æçµæœå°‡é¡¯ç¤ºæ–¼æ­¤...</div>

        <div class="return-home" style="text-align: center; margin-top: 20px;">
            <a href="/index.html" class="btn">è¿”å›é¦–é </a>
        </div>
    </div>
    <script type="py">
        from pyscript import document
        import re
        #å…ƒç´ å­—å…¸ 
        ELEMENT_DICT = {
            "H":  {"name": "Hydrogen", "weight": 1.008, "mp": -259.1, "bp": -252.9, "en": 2.20, "ve": 1, "metal": False},
            "He": {"name": "Helium", "weight": 4.003, "mp": -272.2, "bp": -268.9, "en": 0.00, "ve": 2, "metal": False},
            "Li": {"name": "Lithium", "weight": 6.941, "mp": 180.5, "bp": 1342.0, "en": 0.98, "ve": 1, "metal": True},
            "Be": {"name": "Beryllium", "weight": 9.012, "mp": 1287.0, "bp": 2471.0, "en": 1.57, "ve": 2, "metal": True},
            "B":  {"name": "Boron", "weight": 10.811, "mp": 2075.0, "bp": 4000.0, "en": 2.04, "ve": 3, "metal": False},
            "C":  {"name": "Carbon", "weight": 12.011, "mp": 3550.0, "bp": 4827.0, "en": 2.55, "ve": 4, "metal": False},
            "N":  {"name": "Nitrogen", "weight": 14.007, "mp": -210.0, "bp": -195.8, "en": 3.04, "ve": 5, "metal": False},
            "O":  {"name": "Oxygen", "weight": 15.999, "mp": -218.8, "bp": -183.0, "en": 3.44, "ve": 6, "metal": False},
            "F":  {"name": "Fluorine", "weight": 18.998, "mp": -219.6, "bp": -188.1, "en": 3.98, "ve": 7, "metal": False},
            "Ne": {"name": "Neon", "weight": 20.180, "mp": -248.6, "bp": -246.1, "en": 0.00, "ve": 8, "metal": False},
            "Na": {"name": "Sodium", "weight": 22.990, "mp": 97.7, "bp": 883.0, "en": 0.93, "ve": 1, "metal": True},
            "Mg": {"name": "Magnesium", "weight": 24.305, "mp": 650.0, "bp": 1090.0, "en": 1.31, "ve": 2, "metal": True},
            "Al": {"name": "Aluminum", "weight": 26.982, "mp": 660.3, "bp": 2519.0, "en": 1.61, "ve": 3, "metal": True},
            "Si": {"name": "Silicon", "weight": 28.085, "mp": 1414.0, "bp": 3265.0, "en": 1.90, "ve": 4, "metal": False},
            "P":  {"name": "Phosphorus", "weight": 30.974, "mp": 44.1, "bp": 280.5, "en": 2.19, "ve": 5, "metal": False},
            "S":  {"name": "Sulfur", "weight": 32.065, "mp": 115.2, "bp": 444.6, "en": 2.58, "ve": 6, "metal": False},
            "Cl": {"name": "Chlorine", "weight": 35.453, "mp": -101.5, "bp": -34.0, "en": 3.16, "ve": 7, "metal": False},
            "Ar": {"name": "Argon", "weight": 39.948, "mp": -189.3, "bp": -185.8, "en": 0.00, "ve": 8, "metal": False},
            "K":  {"name": "Potassium", "weight": 39.098, "mp": 63.4, "bp": 759.0, "en": 0.82, "ve": 1, "metal": True},
        }
        def parse_formula():
            formula_str = document.querySelector("#formula").value
            nodes = []
            matches = re.findall(r"\(([A-Za-z]+)\)\((\d+)\)", formula_str)
            for sym, count in matches:
                if sym in ELEMENT_DICT:
                    for _ in range(int(count))
                        nodes.append({"sym": sym, "rem_e": ELEMENT_DICT[sym]["ve"]})
            return nodes
        def generate_ids(event):
            nodes = parse_formula()
            hint_div = document.querySelector("#id_hint")
            if not nodes:
                hint_div.innerText = "âš  æ ¼å¼ä¸æ­£ç¢ºï¼è«‹ä½¿ç”¨ (C)(1)(O)(2) æ ¼å¼ã€‚"
                return
            hints = [f"[{i}]:{n['sym']}" for i, n in enumerate(nodes)]
            hint_div.innerText = "åŸå­ç·¨è™Ÿï¼š " + "  ".join(hints)
            document.querySelector("#bonds").placeholder = "è‹¥ç·¨è™Ÿ 0 èˆ‡ 1 æœ‰é€£æ¥ï¼Œè«‹åœ¨æ­¤è¼¸å…¥ï¼š0 1"
        def run_analysis(event):
            output_div = document.querySelector("#output")
            nodes = parse_formula()
            if not nodes:
                output_div.innerText = "éŒ¯èª¤ï¼šè«‹å…ˆè¼¸å…¥åŒ–å­¸å¼ä¸¦é»æ“Šç”Ÿæˆç·¨è™Ÿã€‚"
                return
            charge = int(document.querySelector("#charge").value or 0)
            bonds_str = document.querySelector("#bonds").value
            total_atoms = len(nodes)
            adj = [[0] * total_atoms for _ in range(total_atoms)]
            #è§£æé€£æ¥é—œä¿‚
            for line in bonds_str.strip().split('\n'):
                try:
                    parts = line.split()
                    if len(parts) == 2:
                        a, b = map(int, parts)
                        if a < total_atoms and b < total_atoms:
                            adj[a][b] = adj[b][a] = 1   
                except: continue
            #è‡ªå‹•éµçµé‚è¼¯ 
            if total_atoms > 0:
                nodes[0]["rem_e"] -= charge # å°‡é›»è·æ”¾å…¥ä¸­å¿ƒåŸå­
            # è¨ˆç®—å…¨å–®éµ
            for i in range(total_atoms):
                for j in range(i + 1, total_atoms):
                    if adj[i][j] >= 1:
                        nodes[i]["rem_e"] -= 1
                        nodes[j]["rem_e"] -= 1
            # å˜—è©¦å¤šéµåˆ†é…
            for i in range(total_atoms):
                while nodes[i]["rem_e"] > 0:
                    added = False
                    for j in range(total_atoms):
                        if adj[i][j] >= 1 and nodes[j]["rem_e"] > 0:
                            adj[i][j] += 1
                            adj[j][i] += 1
                            nodes[i]["rem_e"] -= 1
                            nodes[j]["rem_e"] -= 1
                            added = True
                            break
                    if not added: break
            res = f"{'ç·¨è™Ÿ':<6} {'åŸå­':<6} {'ç¸½éµæ•¸':<8} {'éµç´šåˆ†é…':<12} {'LP':<6} {'ç©ºé–“å½¢ç‹€':<12}\n"
            res += "="*60 + "\n"
            max_en, min_en, has_HB = -1.0, 10.0, False
            for i in range(total_atoms):
                sym = nodes[i]["sym"]
                e_data = ELEMENT_DICT[sym]
                # çµ±è¨ˆé›»è² åº¦
                if e_data["en"] > max_en: max_en = e_data["en"]
                if e_data["en"] > 0 and e_data["en"] < min_en: min_en = e_data["en"]
                b_sum, nbr, desc = 0, 0, ""
                for j in range(total_atoms):
                    if adj[i][j] > 0:
                        bond_order = adj[i][j]
                        b_sum += bond_order
                        nbr += 1
                        desc += f"{bond_order}-" 
                        neighbor_sym = nodes[j]["sym"]
                        if sym == "H" and (neighbor_sym in ["F", "O", "N"]):
                            has_HB = True
                lp = max(0, nodes[i]["rem_e"] // 2)
                sn = nbr + lp
                sh = "æœ«ç«¯"
                if sn == 4:
                    sh = "å››é¢é«”" if lp == 0 else ("ä¸‰è§’éŒ" if lp == 1 else "è§’å½¢")
                elif sn == 3:
                    sh = "å¹³é¢ä¸‰è§’" if lp == 0 else "è§’å½¢"
                elif sn == 2:
                    sh = "ç·šæ€§"
                res += f"{i:<8} {sym:<8} {b_sum:<10} {desc:<14} {lp:<8} {sh}\n"
            #ä½œç”¨åŠ›åˆ¤æ–·é‚è¼¯
            de = max_en - min_en
            force_list = ["å€«æ•¦åˆ†æ•£åŠ›"]
            if has_HB: force_list.insert(0, "æ°«éµ")
            if de > 0.5: force_list.insert(0, "å¶æ¥µ-å¶æ¥µåŠ›")
            report = f"\n[åˆ†æå ±å‘Š]\n"
            report += f"æ¥µæ€§å¼·åº¦ (Î”EN): {de:.2f}\n"
            report += f"ä¸»è¦ä½œç”¨åŠ›: {', '.join(force_list)}\n"
            output_div.innerText = res + report
        def reset_all(event):
            document.querySelector("#formula").value = ""
            document.querySelector("#charge").value = "0"
            document.querySelector("#bonds").value = ""
            document.querySelector("#id_hint").innerText = "ç­‰å¾…è¼¸å…¥åŒ–å­¸å¼..."
            document.querySelector("#output").innerText = "åˆ†æçµæœå°‡é¡¯ç¤ºæ–¼æ­¤..."
    </script>
</main>